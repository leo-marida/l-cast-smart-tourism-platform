<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L-CAST Admin Portal</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary-bg: #f8f9fa;
        --sidebar-bg: #212529;
        --sidebar-width: 260px;
      }
      body {
        background-color: var(--primary-bg);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow-x: hidden;
      }

      /* Sidebar */
      #sidebar {
        width: var(--sidebar-width);
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background-color: var(--sidebar-bg);
        color: white;
        transition: all 0.3s;
        z-index: 1000;
      }
      #sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 15px 20px;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      #sidebar .nav-link:hover,
      #sidebar .nav-link.active {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
        border-left: 4px solid #0d6efd;
      }
      #sidebar .brand {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 25px 20px;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Badge for requests */
      .req-badge {
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: bold;
      }

      /* Main Content */
      #content {
        margin-left: var(--sidebar-width);
        padding: 30px;
        transition: all 0.3s;
      }

      /* Login Screen */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0d6efd 0%, #000000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 420px;
      }

      /* Dashboard Cards */
      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
      }
      .stat-icon {
        font-size: 2.5rem;
        opacity: 0.15;
      }

      /* Tables & Containers */
      .admin-table-container {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
        margin-bottom: 30px; /* Spacing between sections */
      }

      /* Specific Styles for Accepted/Rejected Rows */
      .row-accepted {
        background-color: #d1e7dd !important;
      }
      .row-rejected {
        background-color: #f8d7da !important;
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #6c757d;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 5px;
      }

      /* Status Badges */
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
      }
      .status-safe {
        background-color: #d1e7dd;
        color: #0f5132;
      }
      .status-caution {
        background-color: #fff3cd;
        color: #664d03;
      }
      .status-danger {
        background-color: #f8d7da;
        color: #842029;
      }
      
      /* Notification Search Styles */
      .user-select-container { 
          max-height: 200px; 
          overflow-y: auto; 
          border: 1px solid #ced4da; 
          border-radius: 5px; 
          display: none; 
      }

      .hidden {
        display: none !important;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        #sidebar {
          margin-left: -260px;
        }
        #sidebar.active {
          margin-left: 0;
        }
        #content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- 1. Login Screen -->
    <div id="login-screen">
      <div class="login-card">
        <div class="text-center mb-4">
          <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
          <h3>Admin Portal</h3>
          <p class="text-muted">Secure Access Only</p>
        </div>
        <form id="loginForm">
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input
              type="email"
              class="form-control"
              id="email"
              placeholder="Enter Email"
              required
              autocomplete="email"
            />
          </div>
          <div class="mb-4">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="Enter Password"
              required
              autocomplete="current-password"
            />
          </div>
          <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
            Login
          </button>
          <div
            id="loginError"
            class="text-danger mt-3 text-center small fw-bold"
          ></div>
        </form>
      </div>
    </div>

    <!-- 2. Application Interface -->
    <div id="app-interface" class="hidden">
      <!-- Sidebar -->
      <nav id="sidebar">
        <div class="brand">L-CAST Admin</div>
        <ul class="nav flex-column mt-3">
          <li class="nav-item">
            <a class="nav-link active" href="#" onclick="navigate('dashboard'); return false;">
              <span><i class="fas fa-chart-line me-3" aria-hidden="true"></i> Dashboard</span>
            </a>
          </li>
          <!-- User Requests -->
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="navigate('requests'); return false;">
              <span><i class="fas fa-inbox me-3" aria-hidden="true"></i> User Requests</span>
              <span id="sidebar-badge" class="req-badge hidden">0</span>
            </a>
          </li>
          <!-- NEW: Notification Feature -->
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="navigate('notifications'); return false;">
              <span><i class="fas fa-bell me-3" aria-hidden="true"></i> Send Notification</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="navigate('users'); return false;">
              <span><i class="fas fa-users me-3" aria-hidden="true"></i> Users</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="navigate('pois'); return false;">
              <span><i class="fas fa-map-marked-alt me-3" aria-hidden="true"></i> Locations</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="navigate('posts'); return false;">
              <span><i class="fas fa-comments me-3" aria-hidden="true"></i> Moderation</span>
            </a>
          </li>
          <li class="nav-item mt-5 border-top border-secondary pt-3">
            <a class="nav-link text-danger" href="#" onclick="logout(); return false;">
              <span><i class="fas fa-sign-out-alt me-3" aria-hidden="true"></i> Logout</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main id="content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 id="page-title" class="fw-bold">Overview</h2>
          <div class="text-muted small">
            Logged in as <strong id="admin-name">Admin</strong>
          </div>
        </div>

        <!-- Dynamic Views -->
        <div id="view-dashboard"></div>
        <div id="view-requests" class="hidden"></div>
        <!-- NEW: Notifications View -->
        <div id="view-notifications" class="hidden">
            <div class="row">
                <div class="col-md-8">
                    <div class="admin-table-container">
                        <h5 class="mb-4">Send New Notification</h5>
                        <form id="notificationForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Recipient</label>
                                <div class="d-flex gap-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="targetUser" id="targetAll" value="all" checked onchange="toggleUserSelect()">
                                        <label class="form-check-label" for="targetAll">All Users (Public)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="targetUser" id="targetSpecific" value="specific" onchange="toggleUserSelect()">
                                        <label class="form-check-label" for="targetSpecific">Specific User</label>
                                    </div>
                                </div>
                                
                                <!-- User Search (Hidden by default) -->
                                <div id="userSearchBox" class="hidden mt-2">
                                    <input type="text" class="form-control mb-2" id="userSearchInput" placeholder="Search user by name or email..." onkeyup="filterUsers()">
                                    <select class="form-select" id="userSelect" size="5"></select>
                                    <div class="form-text">Select a user from the list above.</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Title</label>
                                <input type="text" class="form-control" id="notifTitle" required placeholder="e.g., Road Closure Alert">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Message</label>
                                <textarea class="form-control" id="notifMessage" rows="4" required placeholder="Type your message here..."></textarea>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="sendNotification()">
                                <i class="fas fa-paper-plane me-2"></i> Send Notification
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="view-users" class="hidden"></div>
        <div id="view-pois" class="hidden"></div>
        <div id="view-posts" class="hidden"></div>
      </main>
    </div>

    <!-- 3. Modals -->
    <!-- Safety Override Modal -->
    <div
      class="modal fade"
      id="safetyModal"
      tabindex="-1"
      aria-labelledby="safetyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="safetyModalLabel">
              Update Safety Status
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modalPoiId" />
            <p>Updating status for: <strong id="modalPoiName"></strong></p>

            <div class="mb-3">
              <label for="modalSafetyStatus" class="form-label">Select Safety Level</label>
              <select class="form-select" id="modalSafetyStatus">
                <option value="Safe">Safe (Green)</option>
                <option value="Caution">Caution (Yellow)</option>
                <option value="Danger">Danger (Red)</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitSafetyUpdate()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Admin Logic -->
    <script>
      const API_URL = "http://localhost:3000/api/admin";
      let token = localStorage.getItem("admin_token");
      let allUsersCache = []; // Cache for user search

      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        if (token) {
          showApp();
        }
      });

      // --- Authentication ---
      document.getElementById("loginForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const errorDiv = document.getElementById("loginError");

          errorDiv.textContent = "Verifying credentials...";

          try {
            const res = await fetch(`${API_URL}/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });

            const data = await res.json();

            if (res.ok) {
              token = data.token;
              localStorage.setItem("admin_token", token);
              if (data.username) document.getElementById("admin-name").textContent = data.username;
              showApp();
            } else {
              errorDiv.textContent = data.error || "Login Failed";
            }
          } catch (err) {
            errorDiv.textContent = "Server Connection Error. Ensure Backend is running.";
          }
        });

      function logout() {
        localStorage.removeItem("admin_token");
        location.reload();
      }

      function showApp() {
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app-interface").classList.remove("hidden");
        navigate("dashboard");
        checkPendingRequests(); // Start checking for badge
      }

      // --- Navigation ---
      function navigate(view) {
        // Hide all views
        ["dashboard", "requests", "notifications", "users", "pois", "posts"].forEach((v) => {
          document.getElementById(`view-${v}`).classList.add("hidden");
        });

        // Update Active Link
        document.querySelectorAll(".nav-link").forEach((l) => l.classList.remove("active"));
        const activeLink = document.querySelector(`.nav-link[onclick*="'${view}'"]`);
        if (activeLink) activeLink.classList.add("active");

        // Show selected view
        document.getElementById(`view-${view}`).classList.remove("hidden");

        // Set Title
        const titles = {
          dashboard: "System Overview",
          requests: "User Request Management",
          notifications: "Send Notifications", // Added Title
          users: "User Management",
          pois: "Locations & Safety Control",
          posts: "Content Moderation",
        };
        document.getElementById("page-title").textContent = titles[view];

        // Fetch Data
        if (view === "dashboard") loadDashboard();
        if (view === "requests") loadRequests();
        if (view === "notifications") loadNotificationUsers(); // Load users for search
        if (view === "users") loadUsers();
        if (view === "pois") loadPOIs();
        if (view === "posts") loadPosts();
      }

      // --- API Helper ---
      async function authFetch(endpoint, options = {}) {
        options.headers = {
          ...options.headers,
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };

        try {
          const res = await fetch(`${API_URL}${endpoint}`, options);
          if (res.status === 401 || res.status === 403) {
            logout(); // Kick user out if token invalid
            return null;
          }
          return res.json();
        } catch (err) {
          console.error("Fetch error:", err);
          return null;
        }
      }

      // --- DASHBOARD LOGIC ---
      async function loadDashboard() {
        const data = await authFetch("/stats");
        if (!data) return;

        const html = `
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card border-start border-4 border-primary">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2">Total Users</h6>
                                <h2 class="mb-0 fw-bold">${data.users}</h2>
                            </div>
                            <i class="fas fa-users stat-icon text-primary" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card border-start border-4 border-success">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2">Active POIs</h6>
                                <h2 class="mb-0 fw-bold">${data.pois}</h2>
                            </div>
                            <i class="fas fa-map-marker-alt stat-icon text-success" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card border-start border-4 border-info">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2">Total Posts</h6>
                                <h2 class="mb-0 fw-bold">${data.posts}</h2>
                            </div>
                            <i class="fas fa-camera stat-icon text-info" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card border-start border-4 border-danger">
                            <div>
                                <h6 class="text-muted text-uppercase mb-2">Active Alerts</h6>
                                <h2 class="mb-0 fw-bold">${data.alerts}</h2>
                            </div>
                            <i class="fas fa-exclamation-triangle stat-icon text-danger" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            `;
        document.getElementById("view-dashboard").innerHTML = html;
      }

      // --- REQUESTS LOGIC ---
      async function checkPendingRequests() {
        const reqs = await authFetch("/requests");
        if (reqs) {
          const pendingCount = reqs.filter((r) => r.status === "pending").length;
          const badge = document.getElementById("sidebar-badge");
          if (pendingCount > 0) {
            badge.textContent = pendingCount;
            badge.classList.remove("hidden");
          } else {
            badge.classList.add("hidden");
          }
        }
      }

      async function loadRequests() {
        const reqs = await authFetch("/requests");
        if (!reqs) return;

        checkPendingRequests();

        const pendingReqs = reqs.filter((r) => r.status === "pending");
        const acceptedReqs = reqs.filter((r) => r.status === "approved");
        const rejectedReqs = reqs.filter((r) => r.status === "rejected");

        let html = "";

        // 1. PENDING SECTION
        html += `<h5 class="section-title text-primary"><i class="fas fa-clock me-2"></i> Pending Requests</h5>`;
        if (pendingReqs.length === 0) {
          html += `<div class="alert alert-light border mb-4">There are no pending requests.</div>`;
        } else {
          let rows = pendingReqs.map((r) => `
            <tr>
                <td><strong>${r.name}</strong></td>
                <td>${r.region}</td>
                <td>${r.category || "-"}</td>
                <td>@${r.username || "User " + r.user_id}</td>
                <td>
                    <button class="btn btn-sm btn-success me-2" onclick="setReqStatus(${r.id}, 'approved')"><i class="fas fa-check"></i> Accept</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="setReqStatus(${r.id}, 'rejected')"><i class="fas fa-times"></i> Reject</button>
                </td>
            </tr>`).join("");
          html += `<div class="admin-table-container mb-4"><table class="table table-hover align-middle"><thead><tr><th>Name</th><th>Region</th><th>Category</th><th>User</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        // 2. ACCEPTED SECTION
        html += `<h5 class="section-title text-success mt-4"><i class="fas fa-check-circle me-2"></i> Accepted Requests</h5>`;
        if (acceptedReqs.length > 0) {
          let rows = acceptedReqs.map((r) => `
            <tr class="table-success-soft" style="background-color: #d1e7dd;">
                <td><strong>${r.name}</strong></td>
                <td>${r.region}</td>
                <td>${r.category || "-"}</td>
                <td>@${r.username || "User " + r.user_id}</td>
                <td><span class="badge bg-success">Approved & Notified</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-dark" onclick="deleteRequest(${r.id})" title="Remove from list"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join("");
          html += `<div class="admin-table-container mb-4"><table class="table align-middle"><thead><tr><th>Name</th><th>Region</th><th>Category</th><th>User</th><th>Status</th><th class="text-end">Delete</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        } else {
          html += `<p class="text-muted small ps-2 mb-4">No accepted requests in history.</p>`;
        }

        // 3. REJECTED SECTION
        html += `<h5 class="section-title text-danger mt-4"><i class="fas fa-times-circle me-2"></i> Rejected Requests</h5>`;
        if (rejectedReqs.length > 0) {
          let rows = rejectedReqs.map((r) => `
            <tr class="table-danger-soft" style="background-color: #f8d7da;">
                <td><strong>${r.name}</strong></td>
                <td>${r.region}</td>
                <td>${r.category || "-"}</td>
                <td>@${r.username || "User " + r.user_id}</td>
                <td><span class="badge bg-danger">Rejected & Notified</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-dark" onclick="deleteRequest(${r.id})" title="Remove from list"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join("");
          html += `<div class="admin-table-container"><table class="table align-middle"><thead><tr><th>Name</th><th>Region</th><th>Category</th><th>User</th><th>Status</th><th class="text-end">Delete</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        } else {
          html += `<p class="text-muted small ps-2">No rejected requests in history.</p>`;
        }

        document.getElementById("view-requests").innerHTML = html;
      }

      async function setReqStatus(id, status) {
        let confirmMsg = "";
        if (status === "approved") {
          confirmMsg = "Accept this request?\n\nThe user will be notified that the location will be added soon.";
        } else {
          confirmMsg = "Reject this request?\n\nThe user will be notified with an apology.";
        }

        if (!confirm(confirmMsg)) return;

        const res = await authFetch(`/requests/${id}/status`, {
          method: "PUT",
          body: JSON.stringify({ status: status }),
        });

        if (res && res.success) {
          loadRequests(); 
        } else {
          alert("Error updating status");
        }
      }

      async function deleteRequest(id) {
        if (!confirm("Remove this request from history permanently?")) return;
        await authFetch(`/requests/${id}`, { method: "DELETE" });
        loadRequests();
      }

      // --- NOTIFICATION LOGIC ---
      function toggleUserSelect() {
          const isSpecific = document.getElementById('targetSpecific').checked;
          const box = document.getElementById('userSearchBox');
          if (isSpecific) box.classList.remove('hidden');
          else box.classList.add('hidden');
      }

      async function loadNotificationUsers() {
          allUsersCache = await authFetch('/users'); 
          filterUsers(); // Initial render
      }

      function filterUsers() {
          const input = document.getElementById('userSearchInput').value.toLowerCase();
          const select = document.getElementById('userSelect');
          select.innerHTML = '';
          
          const filtered = allUsersCache.filter(u => 
              u.username.toLowerCase().includes(input) || 
              u.email.toLowerCase().includes(input)
          );

          filtered.forEach(u => {
              const option = document.createElement('option');
              option.value = u.id;
              option.textContent = `${u.username} (${u.email})`;
              select.appendChild(option);
          });
      }

      async function sendNotification() {
          const title = document.getElementById('notifTitle').value;
          const message = document.getElementById('notifMessage').value;
          const isSpecific = document.getElementById('targetSpecific').checked;
          
          if(!title || !message) return alert("Please fill title and message");

          let payload = { title, message, type: 'all' };
          if(isSpecific) {
              payload.type = 'specific';
              payload.user_id = document.getElementById('userSelect').value;
              if(!payload.user_id) return alert("Please select a user");
          }

          if(!confirm("Send Notification?")) return;
          const res = await authFetch('/send-notification', { method: 'POST', body: JSON.stringify(payload) });
          if(res && res.success) { 
              alert("Sent Successfully!"); 
              document.getElementById('notificationForm').reset();
              toggleUserSelect();
          }
      }

      // --- USERS LOGIC ---
      async function loadUsers() {
        const users = await authFetch("/users");
        if (!users) return;

        let rows = users.map((u) => `
                <tr>
                    <td><small class="text-muted">#${u.id}</small></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle p-2 me-3 d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-user text-secondary" aria-hidden="true"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${u.username}</div>
                                <small class="text-muted">${u.email}</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge ${u.role === "admin" ? "bg-danger" : "bg-secondary"}">${u.role}</span></td>
                    <td>${u.post_count}</td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                </tr>`).join("");

        document.getElementById("view-users").innerHTML = `
                <div class="admin-table-container">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light"><tr><th>ID</th><th>User Details</th><th>Role</th><th>Posts</th><th>Joined</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
      }

      // --- POIS LOGIC ---
      async function loadPOIs() {
        const pois = await authFetch("/pois");
        if (!pois) return;

        let rows = pois.map((p) => {
            let badgeClass = p.safety_status === "Safe" ? "status-safe" : p.safety_status === "Caution" ? "status-caution" : "status-danger";
            return `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.region}</td>
                    <td>${p.category || '<span class="text-muted">-</span>'}</td>
                    <td><span class="status-badge ${badgeClass}">${p.safety_status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-dark" onclick="openSafetyModal(${p.id}, '${p.name}', '${p.safety_status}')" aria-label="Edit status for ${p.name}">
                            <i class="fas fa-edit" aria-hidden="true"></i> Edit
                        </button>
                    </td>
                </tr>`;
          }).join("");

        document.getElementById("view-pois").innerHTML = `
                <div class="admin-table-container">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light"><tr><th>Name</th><th>Region</th><th>Category</th><th>Current Status</th><th>Actions</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
      }

      // --- POSTS LOGIC ---
      async function loadPosts() {
        const posts = await authFetch("/posts");
        if (!posts) return;

        let rows = posts.map((p) => `
                <tr>
                    <td><small>#${p.id}</small></td>
                    <td>
                        <strong>@${p.username || "Unknown"}</strong><br>
                        <small class="text-muted"><i class="fas fa-map-marker-alt ms-1" aria-hidden="true"></i> ${p.location || "No Location"}</small>
                    </td>
                    <td style="max-width: 300px;">
                        <div class="text-truncate">${p.content}</div>
                        ${p.image_url ? '<small><a href="#" class="text-primary text-decoration-none"><i class="fas fa-image" aria-hidden="true"></i> View Image</a></small>' : ""}
                    </td>
                    <td><span class="badge bg-light text-dark border">${p.visibility}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${p.id})" aria-label="Delete post ${p.id}">
                            <i class="fas fa-trash" aria-hidden="true"></i>
                        </button>
                    </td>
                </tr>`).join("");

        document.getElementById("view-posts").innerHTML = `
                <div class="admin-table-container">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light"><tr><th>ID</th><th>Author & Location</th><th>Content</th><th>Visibility</th><th>Actions</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
      }

      // --- ACTIONS ---

      // Open Modal
      const safetyModal = new bootstrap.Modal(document.getElementById("safetyModal"));
      function openSafetyModal(id, name, currentStatus) {
        document.getElementById("modalPoiId").value = id;
        document.getElementById("modalPoiName").textContent = name;
        document.getElementById("modalSafetyStatus").value = currentStatus;
        safetyModal.show();
      }

      // Submit Override
      async function submitSafetyUpdate() {
        const id = document.getElementById("modalPoiId").value;
        const status = document.getElementById("modalSafetyStatus").value;

        await authFetch("/override-safety", {
          method: "POST",
          body: JSON.stringify({ poi_id: id, status: status }),
        });

        safetyModal.hide();
        loadPOIs(); // Refresh table
      }

      // Delete Post
      async function deletePost(id) {
        if (confirm("Are you sure you want to delete this post? This cannot be undone.")) {
          await authFetch(`/posts/${id}`, { method: "DELETE" });
          loadPosts();
        }
      }
    </script>
  </body>
</html>